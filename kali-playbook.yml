---
# Playbook to configure Kali VM
- hosts: kali
  tasks:
    - name: Update all packages to the latest version
      apt:
        update_cache: true
        upgrade: safe
  
    - name: Install packages
      apt:
        name: "{{ kali_packages }}"
        state: latest

# Install extra apps and files
- hosts: kali
  roles:
    - ansible-role-chromium
    - ansible-role-empire
    - ansible-role-hcxdumptool
    - ansible-role-hcxtools
    - ansible-role-nullinux
    - ansible-role-vscode
  tasks:
    - name: Clone git repositories
      git:
        repo: "{{ item.repo }}"
        dest: "/opt/{{ item.name }}"
        version: "{{ item.version | default('master') }}"
      loop: "{{ git_repos | flatten(levels=1) }}"

    - name: Enable Postgresql service
      service:
        name: postgresql
        state: started
        enabled: true

    - name: Check msfdb status
      command: msfdb status
      register: msfdb_status

    - name: Initialize msfdb
      command: msfdb init
      when: "'No configuration file found' in msfdb_status.stdout"

    - name: Configure OpenSSL
      lineinfile:
        path: /etc/ssl/openssl.cnf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - regexp: "^MinProtocol ="
          line: "MinProtocol = None"
        - regexp: "^CipherStrings ="
          line: "CipherStrings = DEFAULT"

    - name: Create /root/BurpSuite directory for extensions
      file:
        path: /root/BurpSuite
        state: directory

    - name: Download Jython for Burp Suite
      get_url:
        src: https://repo1.maven.org/maven2/org/python/jython-standalone/2.7.1/jython-standalone-2.7.1.jar
        dest: /root/BurpSuite/jython-standalone-2.7.1.jar
        checksum: "sha1:942c3294840dc9dfb3528d775f4d02a6d57c421f"

    - name: Download Jruby for Burp Suite
      get_url:
        src: https://repo1.maven.org/maven2/org/jruby/jruby-complete/9.2.5.0/jruby-complete-9.2.5.0.jar
        dest: /root/BurpSuite/jruby-complete-9.2.5.0.jar
        checksum: "sha265:070d6b8a311aea95b6024f3ecb6de2bd0ec56da80883c9708254caa9e535aeca"
